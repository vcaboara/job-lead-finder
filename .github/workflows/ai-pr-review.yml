name: AI PR Review

on:
  issue_comment:
    types: [created]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    # Only trigger on PR comments that explicitly request review
    if: |
      github.event.issue.pull_request &&
      (
        contains(github.event.comment.body, '@copilot review') ||
        contains(github.event.comment.body, '@ai-review')
      )
    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: React to review request
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('head_ref', pr.data.head.ref);
            return pr.data;

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.pr.outputs.head_sha }}

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files compared to base branch
          git fetch origin ${{ steps.pr.outputs.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr.outputs.base_ref }}...HEAD | grep -E '\.(py|js|ts|tsx|jsx|html|css)$' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No reviewable files changed"
            echo "files=" >> $GITHUB_OUTPUT
          else
            # Convert to JSON array for easier processing
            FILES_JSON=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n")[:-1]')
            echo "files=$FILES_JSON" >> $GITHUB_OUTPUT
            echo "Changed files: $CHANGED_FILES"
          fi

      - name: Get PR diff
        id: pr-diff
        if: steps.changed-files.outputs.files != ''
        run: |
          # Get unified diff for review
          git diff origin/${{ steps.pr.outputs.base_ref }}...HEAD > pr.diff

          # Truncate if too large (>50KB) to avoid API limits
          if [ $(stat -f%z pr.diff 2>/dev/null || stat -c%s pr.diff) -gt 51200 ]; then
            echo "Diff too large, truncating to 50KB"
            head -c 51200 pr.diff > pr.diff.tmp
            mv pr.diff.tmp pr.diff
            echo "...[truncated]" >> pr.diff
          fi

          # Escape for JSON
          DIFF_CONTENT=$(cat pr.diff | jq -R -s .)
          echo "diff=$DIFF_CONTENT" >> $GITHUB_OUTPUT

      - name: Get PR comments and reviews
        id: pr-comments
        if: steps.changed-files.outputs.files != ''
        run: |
          # Fetch PR comments (issue comments)
          echo "Fetching PR comments..."
          COMMENTS=$(gh api "/repos/${{ github.repository }}/issues/${{ context.issue.number }}/comments" \
            --jq '.[] | "**\(.user.login)** (\(.created_at | split("T")[0])):\n\(.body)\n"' 2>/dev/null || echo "")

          # Fetch review comments (inline code comments)
          echo "Fetching review comments..."
          REVIEW_COMMENTS=$(gh api "/repos/${{ github.repository }}/pulls/${{ context.issue.number }}/comments" \
            --jq '.[] | "**\(.user.login)** on \(.path):\(.position // ""):\n> \(.body)\n"' 2>/dev/null || echo "")

          # Combine and save
          if [ -n "$COMMENTS" ] || [ -n "$REVIEW_COMMENTS" ]; then
            echo "## PR Discussion Context" > pr_discussion.txt
            if [ -n "$COMMENTS" ]; then
              echo -e "\n### General Comments:\n$COMMENTS" >> pr_discussion.txt
            fi
            if [ -n "$REVIEW_COMMENTS" ]; then
              echo -e "\n### Code Review Comments:\n$REVIEW_COMMENTS" >> pr_discussion.txt
            fi
            HAS_DISCUSSION="true"
          else
            echo "No PR discussion found" > pr_discussion.txt
            HAS_DISCUSSION="false"
          fi

          echo "has_discussion=$HAS_DISCUSSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: AI Code Review (Gemini/OpenAI/Ollama)
        id: ai-review
        if: steps.changed-files.outputs.files != ''
        run: |
          # Install Node.js for npx
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # Create review prompt based on PR review criteria
          cat > review_prompt.txt << 'EOF'
          Review this pull request against these criteria:

          CODE STRUCTURE:
          - Complex conditionals that could be simplified
          - Nested blocks reducing readability
          - Function size and single responsibility

          CODE QUALITY:
          - Simplicity and conciseness
          - DRY principle violations
          - Modularity and readability

          BEST PRACTICES:
          - Proper logging (not print statements)
          - Error handling with specific exceptions
          - Type hints and docstrings
          - Resource management (context managers)

          PYTHON-SPECIFIC:
          - Pythonic patterns (comprehensions, generators)
          - Standard library usage
          - Performance anti-patterns

          ARCHITECTURE:
          - Separation of concerns
          - Testability
          - Scalability considerations

          TESTING:
          - Coverage of critical paths
          - Test quality and organization

          Provide specific, actionable feedback. Format as:
          ## Summary
          [Brief overview]

          ## Issues Found
          - **File:Line** - [Issue description and suggestion]

          ## Suggestions
          - [Improvement suggestions]

          ## Approval Status
          - [ ] Approved / [ ] Changes Requested / [ ] Comment

          PR Diff:
          EOF

          cat pr.diff >> review_prompt.txt

          # Include PR discussion if available
          if [ -f pr_discussion.txt ] && [ "${{ steps.pr-comments.outputs.has_discussion }}" = "true" ]; then
            echo -e "\n---\n" >> review_prompt.txt
            cat pr_discussion.txt >> review_prompt.txt
            echo -e "\nPlease address any questions or concerns raised in the discussion above.\n" >> review_prompt.txt
          fi

          # Track which provider succeeds
          PROVIDER_USED=""

          # Try Gemini first (you have credits), then OpenAI, then Ollama
          if [ -n "$GEMINI_API_KEY" ]; then
            echo "Using Gemini Flash 2.5 for review..."
            API_RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"contents\": [{
                  \"parts\": [{
                    \"text\": $(cat review_prompt.txt | jq -Rs .)
                  }]
                }],
                \"generationConfig\": {
                  \"temperature\": 0.3,
                  \"maxOutputTokens\": 4096
                }
              }")

            # Save full API response for debugging
            echo "$API_RESPONSE" > api_response.json

            # Check for API errors
            if echo "$API_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
              ERROR_MSG=$(echo "$API_RESPONSE" | jq -r '.error.message')
              echo "âš ï¸ Gemini API Error: $ERROR_MSG"
              REVIEW_OUTPUT=""
            else
              REVIEW_OUTPUT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text' 2>&1 || echo "")
              if [ -n "$REVIEW_OUTPUT" ]; then
                PROVIDER_USED="Gemini Flash 2.5"
              fi
            fi
          fi

          # Fallback to OpenAI if Gemini unavailable or failed
          if [ -z "$REVIEW_OUTPUT" ] || [ "$REVIEW_OUTPUT" = "" ]; then
            echo "Trying OpenAI as fallback..."
            API_RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d "{
                \"model\": \"gpt-4o\",
                \"messages\": [{
                  \"role\": \"system\",
                  \"content\": \"You are an expert code reviewer. Provide detailed, actionable feedback.\"
                }, {
                  \"role\": \"user\",
                  \"content\": $(cat review_prompt.txt | jq -Rs .)
                }],
                \"temperature\": 0.3
              }")

            echo "$API_RESPONSE" > api_response.json

            if echo "$API_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
              ERROR_MSG=$(echo "$API_RESPONSE" | jq -r '.error.message')
              echo "âš ï¸ OpenAI API Error: $ERROR_MSG"
              REVIEW_OUTPUT=""
            else
              REVIEW_OUTPUT=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content' 2>&1 || echo "")
              if [ -n "$REVIEW_OUTPUT" ]; then
                PROVIDER_USED="OpenAI GPT-4o"
              fi
            fi
          fi

          # Last resort: try Ollama (local, free)
          if [ -z "$REVIEW_OUTPUT" ] || [ "$REVIEW_OUTPUT" = "" ]; then
            if [ -n "$OLLAMA_BASE_URL" ]; then
              echo "Attempting review with local Ollama..."
              # Add timeout and better error handling
              API_RESPONSE=$(curl -s --max-time 120 "$OLLAMA_BASE_URL/api/generate" -d "{
                \"model\": \"deepseek-coder:6.7b\",
                \"prompt\": $(cat review_prompt.txt | jq -Rs .),
                \"stream\": false
              }" 2>&1 || echo "")

              # Save response for debugging
              echo "$API_RESPONSE" > ollama_response.json

              # Only parse if we got valid JSON
              if echo "$API_RESPONSE" | jq -e '.response' > /dev/null 2>&1; then
                REVIEW_OUTPUT=$(echo "$API_RESPONSE" | jq -r '.response')
                if [ -n "$REVIEW_OUTPUT" ]; then
                  PROVIDER_USED="Ollama (DeepSeek Coder 6.7B)"
                fi
              else
                echo "âš ï¸ Ollama Error or Timeout: $API_RESPONSE"
                REVIEW_OUTPUT=""
              fi
            fi
          fi

          # If still no output, provide error message
          if [ -z "$REVIEW_OUTPUT" ] || [ "$REVIEW_OUTPUT" = "" ]; then
            REVIEW_OUTPUT="âš ï¸ All AI review providers failed. Check API keys and credits."
            PROVIDER_USED="None (all failed)"
          fi

          # Save review output
          echo "$REVIEW_OUTPUT" > review_output.txt

          # Escape for GitHub output
          REVIEW_JSON=$(cat review_output.txt | jq -R -s .)
          echo "review=$REVIEW_JSON" >> $GITHUB_OUTPUT
          echo "provider=$PROVIDER_USED" >> $GITHUB_OUTPUT
        env:
          OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Post review comment
        if: steps.ai-review.outputs.review != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Use fromJSON to safely parse the escaped output
            const review = ${{ steps.ai-review.outputs.review }};
            const provider = '${{ steps.ai-review.outputs.provider }}' || 'AI';

            const comment = `## ðŸ¤– AI Code Review (${provider})

            ${review}

            ---
            *This review was automatically generated. Please verify suggestions before applying.*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Upload review artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-artifacts
          path: |
            pr.diff
            review_prompt.txt
            review_output.txt
            api_response.json
          if-no-files-found: ignore
